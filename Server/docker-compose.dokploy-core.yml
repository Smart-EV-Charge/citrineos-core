# SPDX-FileCopyrightText: 2026 Contributors to the CitrineOS Project
#
# SPDX-License-Identifier: Apache-2.0
services:
  citrine-core:
    build:
      context: ../
      dockerfile: ./Server/deploy.Dockerfile
    environment:
      APP_NAME: ${APP_NAME:-all}
      APP_ENV: docker
      DB_STRATEGY: ${DB_STRATEGY:-migrate}
      BOOTSTRAP_CITRINEOS_CONFIG_FILENAME: ${BOOTSTRAP_CITRINEOS_CONFIG_FILENAME:-config.json}
      BOOTSTRAP_CITRINEOS_DATABASE_HOST: ${BOOTSTRAP_CITRINEOS_DATABASE_HOST}
      BOOTSTRAP_CITRINEOS_DATABASE_PORT: ${BOOTSTRAP_CITRINEOS_DATABASE_PORT:-5432}
      BOOTSTRAP_CITRINEOS_DATABASE_NAME: ${BOOTSTRAP_CITRINEOS_DATABASE_NAME:-citrine}
      BOOTSTRAP_CITRINEOS_DATABASE_USERNAME: ${BOOTSTRAP_CITRINEOS_DATABASE_USERNAME}
      BOOTSTRAP_CITRINEOS_DATABASE_PASSWORD: ${BOOTSTRAP_CITRINEOS_DATABASE_PASSWORD}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_TYPE: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_TYPE:-s3}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_REGION: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_REGION:-us-east-1}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_ENDPOINT: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_ENDPOINT}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_DEFAULT_BUCKET_NAME: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_DEFAULT_BUCKET_NAME:-citrineos-s3-bucket}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_FORCE_PATH_STYLE: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_FORCE_PATH_STYLE:-true}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_ACCESS_KEY_ID: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_ACCESS_KEY_ID}
      BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_SECRET_ACCESS_KEY: ${BOOTSTRAP_CITRINEOS_FILE_ACCESS_S3_SECRET_ACCESS_KEY}
      CITRINEOS_util_messageBroker_amqp_url: ${CITRINEOS_UTIL_MESSAGEBROKER_AMQP_URL}
      CITRINEOS_util_cache_redis_url: ${CITRINEOS_UTIL_CACHE_REDIS_URL}
    expose:
      - "8080"
      - "8081"
      - "8082"
      - "8092"
      - "8443"
      - "8444"
      - "9229"
      - "10000-10500"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const net=require('net');const c=net.createConnection(8080,'127.0.0.1',()=>{c.end();process.exit(0)});c.on('error',()=>process.exit(1));c.setTimeout(5000,()=>{c.destroy();process.exit(1)});\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
